<% current_organization.theme_files.each do |theme_file| %>
  <%# Include global CSS everywhere %>
  <% if theme_file.global %>
    <%= stylesheet_link_tag(
      Rails.application.routes.url_helpers.rails_blob_path(
        theme_file.file,
        disposition: :inline,
        host: current_organization.host
      ),
      media: "all"
    ) %>
    <% next %>
  <% end %>

  <%# Only include CSS when page_url matches current path %>
  <% next if theme_file.page_url.blank? %>
  <% begin %>
  <%   url = theme_file.page_url %>
  <%   uri = URI.parse(url) rescue nil %>
  <%   path_to_match = uri&.path.presence || url %>
  <%   current_url = request.url %>
  <%   should_include = path_to_match.present? && current_url.start_with?(path_to_match) %>
  <% rescue %>
  <%   should_include = false %>
  <% end %>
  <% if should_include %>
    <%= stylesheet_link_tag(
      Rails.application.routes.url_helpers.rails_blob_path(
        theme_file.file,
        disposition: :inline,
        host: current_organization.host
      ),
      media: "all"
    ) %>
  <% end %>
<% end %>


<%# Live preview injector (only enable when previewing) %>
<% if params[:live_preview].present? %>
<script>
  (function() {
    function ensurePreviewStyleTag() {
      var el = document.getElementById("live-css-preview");
      if (!el) {
        el = document.createElement("style");
        el.type = "text/css";
        el.id = "live-css-preview";
        document.head.appendChild(el);
      }
      return el;
    }

    window.addEventListener("message", function(event) {
      var data = event.data || {};
      if (data.type === "live-css") {
        var tag = ensurePreviewStyleTag();
        tag.textContent = data.css || "";
      }
    }, false);
  })();
</script>
<% end %>
